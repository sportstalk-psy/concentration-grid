<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>–¢–∞–±–ª–∏—Ü–∞ –®—É–ª—å—Ç–µ</title>
  <style>
    :root { --gap: 6px; --cell: 44px; --border: #1f2937; --bg: #fff; --muted:#6b7280; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#f5f6f8; }
    header { padding:14px 16px; background:#11161c; color:#fff; font-weight:700; letter-spacing:.02em; }
    main { max-width: 520px; margin: 0 auto; padding: 16px; }
    .card { background: var(--bg); border-radius: 14px; padding: 14px; box-shadow: 0 6px 18px rgba(0,0,0,.06); }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .grow { flex:1; }
    button { cursor:pointer; border:0; border-radius:10px; padding:12px 14px; font-weight:700; }
    .btn-start { background:#cefa07; color:#11161c; }
    .btn-cancel { background:#11161c; color:#cefa07; width:100%; margin-top:12px; }
    .btn-again { background:#cefa07; color:#11161c; width:100%; margin-top:12px; }
    .stats { margin-top: 10px; color: var(--muted); font-weight:600; display:flex; justify-content:space-between; }
    .grid {
      margin-top: 12px;
      display:grid;
      grid-template-columns: repeat(10, minmax(0, 1fr));
      gap: var(--gap);
      user-select:none;
      -webkit-user-select:none;
      touch-action: manipulation;
    }
    .cell {
      height: var(--cell);
      background:#fff;
      border:2px solid var(--border);
      border-radius: 10px;
      display:flex; align-items:center; justify-content:center;
      font-weight:800;
      color:#111827;
      font-variant-numeric: tabular-nums;
    }
    .cell:disabled { opacity:.35; }
    .cell.good { background:#e5e7eb; }
    .cell.bad { background:#f96262; border-color:#bc2b2b; }
    .top { margin-bottom:12px; }
    .title { font-size: 28px; font-weight: 800; margin: 0 0 10px; }
    .help { color:#374151; line-height:1.4; margin:0 0 10px; }
    .hidden { display:none !important; }
    .result { font-size: 20px; font-weight: 800; margin: 0 0 6px; }
    .history { margin-top: 10px; color:#374151; font-size:14px; }
    .history ul { margin:8px 0 0; padding-left: 18px; }
  </style>
</head>
<body>
  <header>–¢–∞–±–ª–∏—Ü–∞ –®—É–ª—å—Ç–µ</header>
  <main>
    <div class="card top" id="intro">
      <p class="title">–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏–∏</p>
      <p class="help">
        –ù–∞–∂–∏–º–∞–π —á–∏—Å–ª–∞ –ø–æ –ø–æ—Ä—è–¥–∫—É –æ—Ç <b>00</b> –¥–æ <b>99</b>. –í—Ä–µ–º—è –∑–∞–ø–∏—à–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
      </p>
      <div class="row">
        <button class="btn-start" id="startBtn">–ù–ê–ß–ê–¢–¨</button>
        <div class="grow"></div>
      </div>
      <div class="history" id="historyBox"></div>
    </div>

    <div class="card hidden" id="game">
      <div class="stats">
        <div>–í—Ä–µ–º—è: <span id="time">0.0</span></div>
        <div>–ù–æ–º–µ—Ä —Å–µ—Å—Å–∏–∏: <span id="current">00</span></div>
      </div>
      <div class="grid" id="grid"></div>
      <button class="btn-cancel" id="cancelBtn">–í–´–ô–¢–ò</button>
    </div>

    <div class="card hidden" id="done">
      <p class="result">–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!</p>
      <p class="help">–í—ã –∑–∞–≤–µ—Ä—à–∏–ª–∏ —Å–µ—Ç–∫—É –∑–∞: <b id="finalTime">0:00</b></p>
      <button class="btn-again" id="againBtn">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</button>
    </div>
  </main>

  <script>
    const startBtn = document.getElementById('startBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const againBtn  = document.getElementById('againBtn');

    const intro = document.getElementById('intro');
    const game  = document.getElementById('game');
    const done  = document.getElementById('done');

    const gridEl = document.getElementById('grid');
    const timeEl = document.getElementById('time');
    const curEl  = document.getElementById('current');
    const finalTimeEl = document.getElementById('finalTime');
    const historyBox = document.getElementById('historyBox');

    let expected = 0;
    let startTs = null;
    let rafId = null;
    let running = false;

    function pad2(n){ return String(n).padStart(2,'0'); }

    function getAnonId() {
      const key = "cg_anon_id";
      let id = localStorage.getItem(key);
      if (!id) {
        id = (crypto?.randomUUID ? crypto.randomUUID() : ("id_" + Math.random().toString(16).slice(2) + Date.now()));
        localStorage.setItem(key, id);
      }
      return id;
    }

    function shuffle(a){
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]] = [a[j],a[i]];
      }
      return a;
    }

    function getAnonId() {
      const key = "cg_anon_id";
      let id = localStorage.getItem(key);
      if (!id) {
        id = (crypto?.randomUUID ? crypto.randomUUID() : ("id_" + Math.random().toString(16).slice(2) + Date.now()));
        localStorage.setItem(key, id);
      }
      return id;
    }

    function formatMs(ms){
      const totalSec = Math.floor(ms/1000);
      const m = Math.floor(totalSec/60);
      const s = totalSec%60;
      return `${m}:${String(s).padStart(2,'0')}`;
    }

    function tick(){
      if(!running) return;
      const ms = performance.now() - startTs;
      timeEl.textContent = (ms/1000).toFixed(1);
      rafId = requestAnimationFrame(tick);
    }

    function stopTimer(){
      running = false;
      if(rafId) cancelAnimationFrame(rafId);
      rafId = null;
    }

    function buildGrid(){
      gridEl.innerHTML = '';
      const nums = shuffle(Array.from({length:100}, (_,i)=>i));
      nums.forEach(n=>{
        const btn = document.createElement('button');
        btn.className = 'cell';
        btn.type = 'button';
        btn.textContent = pad2(n);
        btn.dataset.value = String(n);

        btn.addEventListener('click', () => {
          if (!running) return;

          const v = Number(btn.dataset.value);

          // ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç–∞–ø ‚Äî –ø–æ–¥—Å–≤–µ—Ç–∏—Ç—å –∫—Ä–∞—Å–Ω—ã–º –Ω–∞ –º–≥–Ω–æ–≤–µ–Ω–∏–µ
          if (v !== expected) {
            btn.classList.add('bad');

             // üì≥ –≤–∏–±—Ä–∞—Ü–∏—è (–¢–û–õ–¨–ö–û –µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è)
               if (window.navigator && window.navigator.vibrate) {
                 navigator.vibrate(30);
               }
            
            setTimeout(() => btn.classList.remove('bad'), 180);
            return;
          }

          // ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç–∞–ø ‚Äî —Å–¥–µ–ª–∞—Ç—å —Å–µ—Ä—ã–º –∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
          btn.classList.add('good');
          btn.disabled = true;

          expected++;
          curEl.textContent = pad2(expected);

          if (expected === 100) {
            const ms = performance.now() - startTs;
            finish(ms);
          }
        });

        gridEl.appendChild(btn);
      });
    }

    function showHistory(){
      const key = 'cg_history';
      const list = JSON.parse(localStorage.getItem(key) || '[]');
      if(list.length === 0){
        historyBox.innerHTML = '<b>–ò—Å—Ç–æ—Ä–∏—è:</b> –ø–æ–∫–∞ –ø—É—Å—Ç–æ';
        return;
      }
      const items = list.slice(-5).reverse().map(x=>`<li>${x.time} ‚Äî ${new Date(x.at).toLocaleString()}</li>`).join('');
      historyBox.innerHTML = `<b>–ò—Å—Ç–æ—Ä–∏—è (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 5):</b><ul>${items}</ul>`;
    }

    function saveHistory(ms){
      const key = 'cg_history';
      const list = JSON.parse(localStorage.getItem(key) || '[]');
      list.push({ ms, time: formatMs(ms), at: Date.now() });
      localStorage.setItem(key, JSON.stringify(list));
    }

    function start(){
      expected = 0;
      curEl.textContent = '00';
      timeEl.textContent = '0.0';
      buildGrid();

      intro.classList.add('hidden');
      done.classList.add('hidden');
      game.classList.remove('hidden');

      // iOS/Safari: —Å—Ç–∞—Ä—Ç –ø–æ—Å–ª–µ —è–≤–Ω–æ–≥–æ –∫–ª–∏–∫–∞, —á—Ç–æ–±—ã –≤—Å—ë –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
      startTs = performance.now();
      running = true;
      tick();

      fetch("https://script.google.com/macros/s/AKfycbxcIpdFg1nqxps6YplBC8z4tL3loNXZbBntEx2RNmCTp4SBhdMVeBvojcS5gVgMZWHY/exec", {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({
          time_ms: 0,
          time: "TEST_START",
          anon_id: getAnonId(),
          phone: localStorage.getItem("cg_phone") || "",
          page: location.href,
          utm: new URLSearchParams(location.search).toString(),
          ua: navigator.userAgent
        })
      });

    }

    function cancel(){
      stopTimer();
      intro.classList.remove('hidden');
      game.classList.add('hidden');
      done.classList.add('hidden');
      showHistory();
    }

    function finish(ms){
      stopTimer();
      saveHistory(ms);
      finalTimeEl.textContent = formatMs(ms);
      
      // --- send to Google Sheets webhook ---
      fetch("https://script.google.com/macros/s/AKfycbxcIpdFg1nqxps6YplBC8z4tL3loNXZbBntEx2RNmCTp4SBhdMVeBvojcS5gVgMZWHY/exec", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          time_ms: ms,
          time: formatMs(ms),
          anon_id: getAnonId(),
          phone: localStorage.getItem("cg_phone") || "",
          page: location.href,
          utm: new URLSearchParams(location.search).toString(),
          ua: navigator.userAgent
        })
      }).catch(() => {});
      // --- end send ---

      game.classList.add('hidden');
      done.classList.remove('hidden');
      showHistory();
    }

    startBtn.addEventListener('click', start);
    cancelBtn.addEventListener('click', cancel);
    againBtn.addEventListener('click', start);

    showHistory();
  </script>
</body>
</html>
